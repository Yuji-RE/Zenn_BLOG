---
title: "NeovimとVSCodeのJupyterを同期する拡張機能を自作した話"
emoji: "🧪"
type: "idea" # tech / idea / opinion
topics: [neovim,vscode,jupyter,python,datascience]
published: false
---

## はじめに

**「VS Code が実務のデファクトである以上、Neovim の環境だけに慣れるのはリスク」**

プログラミング勉強を始めて間もない自分がNeovimを触り始めて以来感じてきた危機感が、これです。そして、


- 普段のコーディングは Neovim + CLI で行いたい
- Notebook UI のプレビューやデバッグ、チーム開発では VS Code も使いたい
- `.ipynb` ではなく、あくまでプレーンな `.py` を編集・管理したい

Neovimでデータサイエンスの環境を構築する過程で、このような願望を抱くようになりました。しかし、既存の環境では**自身のニーズ**に寄り添うものがなく、結果的にそのような機能を自作する運びになりました。

そこで、初めてオリジナルの拡張機能を開発し、理想とするワークフローを実現できたことのマイルストーンとして、本記事を公開することにしました。

## 自作拡張機能 nvim-jupy-bridge の実演

VS Code 拡張 「**Neovim - VS Code Notebook Sync Runner**」（以下、`nvim-jupy-bridge`）は、Neovim で編集した ``# %%`` 付きの `.py` を VS Code の Notebook 上で自動実行してくれる拡張です。

![](/images/nvim_jupy_bridge_demo.gif)

上記のデモ映像は、視点ジャンプの位置を「上寄せ」に設定した例です。

プログラムの流れとしては、以下のようになります。
1. Neovim で `# %%` 付きの `.py` ファイルを保存すると、Lua が Jupytext の同期コマンドを実行する
2. 保存されたファイルのメタ情報を、プロジェクト直下の `.vscode/nvim-sync.json` に書き出す
3. nvim-jupy-bridge 拡張が `nvim-sync.json` を監視し、書き出されたメタ情報を受け取る
4. 拡張側が `.py` 内の `# %%` を上から数え、「カーソルが属する `# %%` ブロックが何番目か」をセル index として `.ipynb` 側のセルにジャンプする。
5. Notebook API 経由で Jupyter カーネルが該当セルを実行する

---

本拡張機能の詳細な内容・性能・機能等については、
[GitHub リポジトリ](https://github.com/Yuji-RE/nvim-jupy-bridge) を参照してください。

---


## このワークフローのメリット・デメリット

#### 【メリット】
- **VS Code の Jupyter 機能やその他のリッチな機能をそのまま使える**
- Neovimでの編集は常にプレーンな `.py` なので Git 差分・レビューがしやすい
- Neovim・VS Codeが双方向に同期されるため、どちらのワークスペースからも柔軟に操作可
- ワークスペースが完全に分かれているため、バグやトラブル時に原因を特定しやすい
- CLI ツール・環境との相性が良い
- 視点ジャンプと実行が自動化されるため、操作がシンプルで高速
- ジャンプ位置を調整できる（上寄せ・中央・下寄せなど）

#### 【デメリット】
- 現時点で同期できるのはjupytext経由での `.py` もしくは `.ipynb` ファイルのみ
- VS Code が利用できない環境とは相性が悪い
- Neovim 単体ですべてを完結させたい場合には向かない
- WSL / CLI / Jupytext / VS Code など、ツールチェーン前提

これらをどう評価するかは、普段の開発スタイルや環境によって変わると思います。個人的には現状のトレードオフに不満はないですが、遅延の改善・安定化のために、将来的に外部CLIとPython起動をdaemon化できないかを検討予定です。

## 解決したかった課題（既存の環境との比較）

まず、自分が既存の Neovim × Jupyter 環境に対して感じていた課題を整理します。
※ 筆者の環境やスキル不足、主観に依存する部分が大きい点はご了承ください。

### jupynium.nvim

- NeovimとJupyter Notebookのシームレスなリアルタイム同期が可能
- しかし:
  - サーバー側でほぼ全ての動きをトラッキングするため動作が重い
  - ブラウザの古いJupyter Notebookに依存しており、よりモダンなJupyter Labが利用できない
  - 長い出力が小さなセル内に押し込まれるため、全文を確認するときはセル内でスクロールする必要がある

→ **NeovimとJupyterのシームレスな同期を実現するが、機能面・UI 面の両方で妥協が必要になる場合がある**

---

### iron.nvim

- シンプルな REPL としては軽くて使いやすい
- しかし:
  - グラフ描画やリッチな出力には不向き
  - ターミナルをどれだけ調整しても、本物の Jupyter 環境には及ばない

→ **軽いコードテストには良いが、DSの開発フローには物足りない**

---

### molten.nvim

- Jupyter/ VS Code Jupyter のとほぼ同様の体験が実現できる
- しかし:
  - 依存が多く、導入ハードルが高い
  - 機能によっては不安定な挙動が見られ、オリジナルと完全に同じ体験とは言い難い

→ **CLI相性の恩恵はあるが、「Neovimの良さ」と「Jupyterの良さ」を100%活かしきれない**

---

### quarto.nvim

- レポート・ドキュメント作成向きのワークフローが強み
- しかし:
  - 試行錯誤や探索フェーズの用途とはややズレる

→ **成果物づくり用途に向いているが、分析プロセスへの恩恵は限られる**

---

こうした些細な違和感を踏まえて、

> 「Neovim＝編集用、VS Code＝Notebook・実行用」と役割をはっきり分けたほうが良いのでは？

という発想で組んだのが、ここでの nvim-jupy-bridge を用いた開発フローです。

両エディタのワークスペースが完全に切り離されていることにより、 **Neovimを「編集特化環境」、VSCodeを「ビューア及び統合開発環境」** として明確に差別化できます。お互いの役割を区別することで、管理するプラグインや拡張機能が整理しやすくなったり、お互いの機能・設定への干渉や競合が起きにくく、状況に応じて各エディタのポテンシャルを最大限発揮しやすくなります。この点は、VSCode Neovim 拡張を用いた場合との差別化要素にもなっています。


## おすすめの開発スタイル

nvim-jupy-bridge を用いた開発スタイルとしては、画面分割が推奨です。よって、大きめのモニターもしくはデュアルモニター環境があると快適です。双方向同期が可能なので、任意のエディタ側での操作性を向上させるために、ウィンドウマネージャーを活用するのも利便性向上に役立ちます。

また、VS Code 側は基本的に出力結果のプレビュー専用として使うので、シングルモニター環境なら入力セルを折りたたむと見やすくなります。VSCode 側でよく使うコマンドのショートカットを定義しておくと、Neovim の操作感を損なわずに済みます。


## おわりに（+ 余談）

本記事では、nvim-jupy-bridgeのより個人的な視点からの開発背景と、それを用いたワークフローについてお話しました。この拡張のプロトタイプ自体は去年の秋頃に出来上がっていて、それから徐々に改善を積み重ねて今に至りますが、環境の自己最適化はやっぱり楽しいですね。現在は古いノートパソコンでOS・ターミナル・ブラウザとかも色々実験的にティンカリングして遊んでいますが、時間が溶けすぎて怖いです。数カ月後にはかなり慣れてくると思うので、また何か面白い発見があれば記事にしたいと思います。

それよりも今は統計検定準一級の勉強に集中しないといけなくて焦ってます。先月2級に合格したばかりですが、準一級はいよいよ文系が悲鳴を上げる領域に入ってくるので、気を引き締めて取り組む必要があります。合格出来たら、また学習方法なども記事にしたいですね。また、PythonやSQLの学習についてもこれまでずっと苦戦していましたが、最近やっと自分に合った方法が見つかりつつあるので、上手く両立させていきたいです。
