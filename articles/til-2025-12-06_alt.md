---
title: "NeovimからVSCodeのJupyterを操作する開発フローを実現した話"
emoji: "🧪"
type: "idea" # tech / idea / opinion
topics: [neovim,vscode,jupyter,python,datascience]
published: false
---


## はじめに

**「VS Code が実務のデファクトである以上、Neovim の閉じた環境だけに慣れるのはリスク」**

プログラミング勉強を始めて間もない自分がNeovimを触り始めて以来感じてきた危機感が、これです。そして、


- 普段のコーディングは Neovim + CLI で行いたい
- Notebook UI のプレビューやデバッグ、チーム開発では VS Code も使いたい
- `.ipynb` ではなく、あくまでプレーンな `.py` を編集・管理したい

Neovimでデータサイエンスの環境を構築する過程で、このような願望を抱くようになりました。
しかし、既存の環境では**自身のニーズ・環境**に寄り添うものがなく、結果的にそのような機能を自作する運びになりました。

そこで、初めてゼロからオリジナルの拡張機能を開発し、理想とするワークフローを実現できたことのマイルストーンとして、本記事を公開することにしました。

## 自作拡張機能 nvim-jupy-bridge の実演

VS Code 拡張 「**Neovim - VS Code Notebook Sync Runner**」（以下、`nvim-jupy-bridge`）は、Neovim で編集した ``# %%`` 付きの `.py` を VS Code の Notebook 上で自動実行してくれる拡張です。

##### 環境と構成要素

- Neovim（WSL Ubuntu）
- VS Code（Jupyter 拡張導入済）
- Jupytext
- 自作 VS Code 拡張機能 `nvim-jupy-bridge`
- Neovim 側の Lua 設定

プログラムのざっくりとした流れは以下の通りです。


1. Neovim で `# %%` 付きの `.py` ファイルを保存すると、Lua が Jupytext の同期コマンドを実行する
2. 保存されたファイルのメタ情報を、プロジェクト直下の `.vscode/nvim-sync.json` に書き出す
3. VS Code 拡張が `nvim-sync.json` を監視し、書き出されたメタ情報を受け取る
4. 拡張側が `.py` 内の `# %%` を上から数え、「カーソルが属する `# %%` ブロックが何番目か」をセル index として`.ipynb`側のセルにジャンプする。
5. Notebook API 経由で Jupyter カーネルが該当セルを実行する

※ 本機能は筆者が初心者なりに要件定義・挙動の検証・デバッグを行い、実装面(コーディング等)ではAIツールのアシストを大きく活用して開発した実験段階のものです。
個人の環境では問題なく使用できていますが、他環境での動作再現性および安全性は未検証です。
ご利用は自己責任でお願いいたします。

## このワークフローのメリット・デメリット

##### 【メリット】
- **VS Code の Jupyter 機能やその他のリッチな機能をそのまま使える**
- Neovimでの編集は常にプレーンな `.py` なので Git 差分・レビューがしやすい
- Neovim・VS Codeが双方向に同期されるため、どちらのワークスペースからも柔軟に操作可
- ワークスペースが完全に分かれているため、バグやトラブル時に原因を特定しやすい
- CLI ツール・環境との相性が良い
- 視点ジャンプと実行が自動化されるため、操作がシンプルで高速
- ジャンプ位置を調整できる（上寄せ・中央・下寄せなど）

##### 【デメリット】
- 現時点で同期できるのはjupytext経由での *.py もしくは *.ipynb ファイルのみ
- VS Code が利用できない環境とは相性が悪い
- Neovim 単体ですべてを完結させたい場合には向かない
- WSL / CLI / Jupytext / VS Code など、ツールチェーン前提


このあたりをどう評価するかは、普段の開発スタイルや職場の方針によって変わると思います。
個人的には現状のトレードオフに不満はないが、遅延設定は安定をとるために過剰待機になっている可能性があるので、短縮を検討しています。

## 解決したかった課題（既存の環境）

まず、自分が既存の Neovim × Jupyter 環境に対して感じていた課題を整理します。
※ 筆者の環境やスキル不足、主観によるものです

### jupynium.nvim

- NeovimとJupyter Notebookのシームレスなリアルタイム同期が可能
- しかし:
  - サーバー側でほぼ全ての動きをトラッキングするため動作が重い
  - ブラウザの古いJupyter Notebookに依存しており、よりモダンなJupyter Labが利用できない
  - 長い出力が小さなセル内に押し込まれるため、全文を確認するときはセル内でスクロールする必要がある

→ **手軽に導入できるが、機能面・UI 面の両方で妥協が必要になる場合がある**

---

### iron.nvim

- シンプルな REPL としては軽くて使いやすい
- しかし:
  - グラフ描画やリッチな出力には不向き
  - ターミナルをどれだけ調整しても、本物の Jupyter 環境には及ばない

→ **軽いコードテストには良いが、DSの開発フローには物足りない**

---

### molten.nvim

- Jupyter/ VS Code Jupyter のとほぼ同様の体験が実現できる
- しかし:
  - 編集対象が `.ipynb` ファイルで、プレーンな `.py` ファイルではない
  - 依存が多く、導入ハードルが高い

→ **CLI相性の恩恵はあるが、素直に VS Code を使った方が良い場面が多い**

---

### quarto.nvim

- レポート・ドキュメント作成向きのワークフローが強み
- しかし:
  - 試行錯誤や探索フェーズの用途とはややズレる

→ **成果物づくり用途に向いているが、分析プロセスへの恩恵は限られる**

---

こうした些細な違和感を踏まえて、

> 「Neovim＝編集用、VS Code＝Notebook・実行用」と役割をはっきり分けたほうが良いのでは？

という発想で組んだのが、ここでの nvim-jupy-bridge を用いたワークフローです。

両エディタのワークスペースが完全に切り離されていることにより、**Neovimを「編集特化環境」**、**VSCodeを「ビューア及び統合開発環境」**として明確に差別化できます。お互いの役割を区別することで、管理するプラグインや拡張機能が整理しやすくなったり、お互いの機能・設定への干渉や競合が起きにくく、状況に応じて各エディタのフルポテンシャルを発揮しやすくなります。


## おすすめの開発フロー

- ディスプレイ構成
  - 横置きモニター：Neovim、ドキュメント、AI クライアント
  - 縦置きモニター：VS Code（Jupyter Notebook プレビュー）
- ウィンドウ管理
  - AutoHotkeyスクリプトで、  
    任意のウィンドウへ即座にフォーカス移動

VS Code 側は基本的に出力結果のプレビュー専用として使うので、シングルモニター環境なら入力セルを折りたたむと見やすくなります。
また、VSCode 側でよく使うコマンドのショートカットを定義しておくと、Neovim の操作感を損なわずに済みます。

## おわりに（余談）

余談ですが、初学者である自分がなぜNeovimをメインエディタとして使うようになったのかの経緯を話します。

私はもともとブラウザでJupyterを利用して Python スクリプトを書いていましたが、より実践的な環境にステップアップするために、VS Code に移りました。しかし、 VS Code で Python の環境構築ができなくて、その試行錯誤の末、WSL を使い始めました。結局、VS Code を WSL 接続したところで状況はなにも改善されなかったのですが、その過程で、GUIにはないCLIの透明性とコントロール性の良さに魅力的を感じました。

> 初めての CLI はまるで、ガラス張りの迷宮みたいだった

自分が複雑な構造の中にいても迷子になることなく、目を凝らせばどこからでも必要は情報を取得できる点が特に気に入りました。

そして、CLI やターミナル操作の理解をより深めたかったことと、環境を自分に最適化することの重要性を [Obsidian](https://) で実感していたことから、TUI ツールで拡張性の高い Neovim の利用を開始しました。

Neovim をどうにゅうしてから
